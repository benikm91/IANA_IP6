<!DOCTYPE html>
<html>
   <head>

      <link rel="stylesheet" type="text/css" href="assets/css/bootstrap.css">
      <link rel="stylesheet" type="text/css" href="assets/css/style.css">

      <script type="text/javascript">
         let socket = null;
         let isopen = false;

         let startX = null;
         let startY = null;

         function request_name() {
             document.querySelector('#request_name').style.display = 'flex';
         }

         document.addEventListener('DOMContentLoaded', function() {
             init_map();
         }, false);

         window.onload = function() {

            socket = new WebSocket("ws://127.0.0.1:9000/ws");
            socket.binaryType = "arraybuffer";

            socket.onopen = function() {
               console.log("Connected!");
               isopen = true;
            };

            socket.onmessage = function(e) {
                if (e.data == "request_name")
                    request_name()
                let refresh_map_command = "refresh_map ";
                if (e.data.startsWith(refresh_map_command)) {
                    let map_data = e.data.substring(refresh_map_command.length).split(",");
                    console.log(map_data);
                    console.log(map_data.map(x => parseInt(x)));
                    refresh_map(map_data[0], map_data[1], map_data.slice(2));
                }
               if (typeof e.data === "string") {
                  //console.log("Text message received: " + e.data);
               }
            };

            socket.onclose = function(e) {
               console.log("Connection closed.");
               socket = null;
               isopen = false;
            }
         };

         function submit_name() {
            const name = document.querySelector('input[name="name"]').value;
            if (isopen) {
               socket.send(`name ${name}`);
             document.querySelector('#request_name').style.display = 'none';
               console.log(`submitted name with "${name}".`);
            } else {
               console.warn("Connection not opened.");
            }
         }

         function explore() {
            if (isopen) {
               socket.send("explore");
               console.log("explore command sent.");
            } else {
               console.warn("Connection not opened.");
            }
         }

         function goto_target() {
             const x = document.querySelector('input[name="goto_x"]').value;
             const y = document.querySelector('input[name="goto_y"]').value;
             goto(x, y);
         }

         function goto(x, y, q, qw) {
            if (isopen) {
               socket.send(`goto ${x} ${y} ${q.x} ${q.y} ${q.z} ${qw}`);
               console.log(`goto ${x} ${y} ${q.x} ${q.y} ${q.z} ${qw}`);
            } else {
               console.warn("Connection not opened.")
            }
         }

         function refresh_map(width, height, map) {
             console.log("REFRESH MPA");
             let canvas = document.querySelector('#map');
             canvas.width = width;
             canvas.height = height;
             let context = canvas.getContext('2d');
             let imageData = context.getImageData(0, 0, width, height);
             for (let y = 0; y < height; y++)
                 for (let x = 0; x < width; x++) {
                    let mapIndex = (y * width + x);
                    let color = 255 - parseInt(map[mapIndex] * 2.55);
                    let imageIndex = mapIndex * 4;
                    imageData.data[imageIndex] = color;
                    imageData.data[imageIndex + 1] = color;
                    imageData.data[imageIndex + 2] = color;
                    imageData.data[imageIndex + 3] = 255;
                 }
             context.putImageData(imageData, 0, 0);
         }

         class Vector3 {
             static crossProduct(v1, v2) {
                return new Vector3(
                    v1.y * v2.z - v1.z * v2.y,
                    v1.z * v2.x - v1.x * v2.z,
                    v1.x * v2.y - v1.y * v2.x
                );
             }

             static dotProduct(v1, v2) {
                 return v1.x * v2.x + v1.y * v2.y + v1.z * v2.z;
             }

             constructor(x, y, z) {
                 this.x = x;
                 this.y = y;
                 this.z = z;
             }

             static length(v) {
                 return Math.sqrt(Vector3.dotProduct(v, v));
             }

             normalize() {
                 return Vector3.normalize(this);
             }

             static normalize(v) {
                 let length = Vector3.length(v);
                 return new Vector3(v.x / length, v.y / length, v.z / length);
             }
         }

         function init_map() {
             let canvas = document.querySelector('#map');
             canvas.addEventListener('mousedown', function(e) {
                let rect = canvas.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
             });
             canvas.addEventListener('mouseup', function(e) {
                if (startX === null || startY === null) return true;
                let rect = canvas.getBoundingClientRect();
                let endX = e.clientX - rect.left;
                let endY = e.clientY - rect.top;

                let startV = new Vector3(startX, startY, 0).normalize();
                let endV = new Vector3(endX, endY, 0).normalize();

                let q = Vector3.crossProduct(startV, endV);
                let qw = Vector3.dotProduct(startV, endV);

                console.log(q);

                goto(startX, startY, q, qw);
             });
         }

      </script>
   </head>
   <body>
        <div class="commands">
            <div class="row">
                <div class="col-md-6 command">
                    <button class="btn btn-primary" onclick='explore();'>Explore Modus</button>
                </div>
                <div class="col-md-6 command">
                    <div>
                        <label for="goto_x">X: </label> <input id="goto_x" type="number" name="goto_x" value="0" />
                    </div>
                    <div>
                        <canvas id="map"></canvas>
                        <label for="goto_y">Y: </label> <input id="goto_y" type="number" name="goto_y" value="0" />
                    </div>
                    <button class="btn btn-primary" onclick='goto_target();'>Go to</button>
                </div>
                <div id="request_name" class="col-md-6 command" style="display: none">
                    <div>
                        <label for="name">Name:</label> <input id="name" type="text" name="name" />
                        <button class="btn btn-primary" onclick='submit_name();'>Submit</button>
                    </div>
                </div>
            </div>
        </div>
   </body>
</html>
